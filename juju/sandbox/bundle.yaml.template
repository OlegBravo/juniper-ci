# Deployment of OpenStack and Contrail in Amazon environment.
# 2 nova compute nodes is allocated.
# nova-cloud-controller, glance, keystone, openstack-dashboard and mysql
# should be placed separately because they rewrite haproxy configuration

series: %SERIES%
services:
  ntp:
    charm: "cs:%SERIES%/ntp"
  rabbitmq-server:
    charm: "cs:%SERIES%/rabbitmq-server"
    num_units: 1
    to:
      - "general-1"
  mysql:
    charm: "cs:%SERIES%/percona-cluster"
    num_units: 1
    options:
      root-password: "%PASSWORD%"
      max-connections: 1500
    to:
      - "general-1"
  openstack-dashboard:
    charm: "cs:%SERIES%/openstack-dashboard"
    num_units: 1
    options:
      debug: "true"
      openstack-origin: "%OPENSTACK_ORIGIN%"
    expose: true
    to:
      - "general-1"
  nova-cloud-controller:
    charm: "cs:%SERIES%/nova-cloud-controller"
    num_units: 1
    options:
      console-access-protocol: "novnc"
      debug: "true"
      openstack-origin: "%OPENSTACK_ORIGIN%"
      network-manager: "Neutron"
    expose: true
    to:
      - "general-2"
  nova-compute:
    charm: "cs:%SERIES%/nova-compute"
    num_units: 2
    options:
      debug: "true"
      openstack-origin: "%OPENSTACK_ORIGIN%"
      virt-type: "qemu"
      enable-resize: "true"
      enable-live-migration: "true"
      migration-auth-type: "ssh"
    to:
      - "compute-1"
      - "compute-2"
  glance:
    charm: "cs:%SERIES%/glance"
    num_units: 1
    options:
      debug: "true"
      openstack-origin: "%OPENSTACK_ORIGIN%"
    expose: true
    to:
      - "compute-1"
  keystone:
    charm: "cs:%SERIES%/keystone"
    num_units: 1
    options:
      admin-password: "%PASSWORD%"
      admin-role: "admin"
      debug: "true"
      openstack-origin: "%OPENSTACK_ORIGIN%"
    expose: true
    to:
      - "compute-2"
  neutron-api:
    charm: "cs:%SERIES%/neutron-api"
    num_units: 1
    options:
      debug: "true"
      openstack-origin: "%OPENSTACK_ORIGIN%"
      manage-neutron-plugin-legacy-mode: false
      neutron-security-groups: "true"
    expose: true
    to:
      - "general-3"

  contrail-keystone-auth:
    charm: "%JUJU_REPO%/contrail-keystone-auth"
    series: %SERIES%
    num_units: 1
    to:
      - "contrail-1"
  contrail-controller:
    charm: "%JUJU_REPO%/contrail-controller"
    series: %SERIES%
    num_units: 1
    expose: true
    to:
      - "contrail-1"
  contrail-analyticsdb:
    charm: "%JUJU_REPO%/contrail-analyticsdb"
    series: %SERIES%
    num_units: 1
    expose: true
    to:
      - "contrail-1"
  contrail-analytics:
    charm: "%JUJU_REPO%/contrail-analytics"
    series: %SERIES%
    num_units: 1
    expose: true
    to:
      - "contrail-1"
  contrail-openstack-neutron-api:
    charm: "%JUJU_REPO%/contrail-openstack-neutron-api"
    series: %SERIES%
    options:
      install-sources: "deb http://%REPO_IP%/ubuntu trusty main"
      install-keys: |
        - |
%REPO_KEY%
  contrail-openstack-compute:
    charm: "%JUJU_REPO%/contrail-openstack-compute"
    series: %SERIES%
    options:
      install-sources: "deb http://%REPO_IP%/ubuntu trusty main"
      install-keys: |
        - |
%REPO_KEY%
      vhost-interface: "eth0"


relations:
  # openstack
  - [ "nova-cloud-controller", "mysql" ]
  - [ "nova-compute:shared-db", "mysql:shared-db" ]
  - [ "keystone", "mysql" ]
  - [ "glance", "mysql" ]
  - [ "glance", "keystone" ]
  - [ "nova-cloud-controller", "rabbitmq-server" ]
  - [ "nova-cloud-controller", "keystone" ]
  - [ "nova-cloud-controller", "glance" ]
  - [ "nova-compute", "nova-cloud-controller" ]
  - [ "nova-compute:amqp", "rabbitmq-server:amqp" ]
  - [ "nova-compute", "glance" ]
  - [ "openstack-dashboard", "keystone" ]

  - [ "neutron-api", "mysql" ]
  - [ "neutron-api", "rabbitmq-server" ]
  - [ "neutron-api", "nova-cloud-controller" ]
  - [ "neutron-api", "keystone" ]

  #contrail
  - [ "contrail-controller", "ntp" ]
  - [ "contrail-openstack-compute:juju-info", "ntp:juju-info" ]
  - [ "contrail-controller", "contrail-keystone-auth" ]
  - [ "contrail-keystone-auth", "keystone" ]
  - [ "contrail-controller", "contrail-analytics" ]
  - [ "contrail-controller", "contrail-analyticsdb" ]
  - [ "contrail-analytics", "contrail-analyticsdb" ]
  - [ "contrail-openstack-neutron-api", "neutron-api"]
  - [ "contrail-controller", "contrail-openstack-neutron-api" ]
  - [ "contrail-openstack-compute", "nova-compute" ]
  - [ "contrail-openstack-compute", "contrail-controller"]

machines:
  "general-1":
    series: %SERIES%
    constraints: mem=8G cores=2 root-disk=40G
  "compute-1":
    series: %SERIES%
    constraints: mem=7G cores=4 root-disk=40G
  "compute-2":
    series: %SERIES%
    constraints: mem=7G cores=4 root-disk=40G
  "general-2":
    series: %SERIES%
    constraints: mem=8G cores=2 root-disk=40G
  "general-3":
    series: %SERIES%
    constraints: mem=8G cores=2 root-disk=40G
  "contrail-1":
    series: %SERIES%
    constraints: mem=15G cores=2 root-disk=40G
