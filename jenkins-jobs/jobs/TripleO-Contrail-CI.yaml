- job:
    name: TripleO-Contrail-CI
    description: 'TripleO Contrail CI'
    defaults: global
    node: slave1
    concurrent: true
    parameters:
      - choice:
          name: NUM
          description: "Enironment Nubmer"
          choices:
            - '3'
            - '4'
            - '5'
            - '6'
      - choice:
          name: ENVIRONMENT_OS
          description: "CentOS or RHEL based installation"
          choices:
            - 'centos'
            - 'rhel'
      - choice:
          name: OPENSTACK_VERSION
          description: "Version of the OpenStack"
          choices:
            - 'ocata'
            - 'newton'
            - 'mitaka'
      - choice:
          name: AAA_MODE
          description: "aaa_mode parameter for Contrail Controller"
          choices:
            - 'rbac'
            - 'cloud-admin'
            - 'no-auth'
      - choice:
          name: AAA_MODE_ANALYTICS
          description: "analytics_aaa_mode parameter for Contrail Analytics (auto - equal to aaa_mode)"
          choices:
            - 'auto'
            - 'rbac'
            - 'cloud-admin'
            - 'no-auth'
      - choice:
          name: DPDK
          choices:
            - 'no'
            - 'yes'
      - choice:
          name: CONTROLLER_COUNT
          description: "Count of OS controllers to deploy"
          choices:
            - '1'
            - '3'
            - '5'
      - choice:
          name: CONTRAIL_CONTROLLER_COUNT
          description: Count of contrail controllers to deploy
                        1,3 - number of dedicated nodes
                        controller - deploy to OS controller node
          choices:
            - '1'
            - '3'
            - 'controller'
      - choice:
          name: CONTRAIL_ANALYTICS_COUNT
          description:  Count of contrail analytics to deploy
                        1,3 - number of dedicated nodes
                        controller - deploy to OS controller node
                        contrail-controller - deploy to Contrail controller node
          choices:
            - 'contrail-controller'
            - '1'
            - '3'
            - 'controller'
      - choice:
          name: CONTRAIL_ANALYTICSDB_COUNT
          description:  Count of contrail analytics DB to deploy
                        1,3 - number of dedicated nodes
                        controller - deploy to OS controller node
                        contrail-controller - deploy to dedicated Contrail controller node
          choices:
            - 'contrail-controller'
            - '1'
            - '3'
            - 'controller'
      - choice:
          name: CLEAN_ENV
          choices:
            - 'auto'
            - 'before_only'
            - 'always'
            - 'never'
      - choice:
          name: RHEL_CERT_TEST
          choices:
            - 'no'
            - 'yes'

    scm:
      - juniper-ci
    builders:
      - shell: |
          #!/bin/bash -e
          desc="$ENVIRONMENT_OS $OPENSTACK_VERSION"
          if [[ "$DPDK" == 'yes' ]] ; then
            desc+=' dpdk'
          fi
          desc+=' $AAA_MODE'
          if [[ "$AAA_MODE_ANALYTICS" != 'auto' ]] ; then
            desc+="/${AAA_MODE_ANALYTICS}"
          fi
          if [[ "$RHEL_CERT_TEST" == 'yes' ]] ; then
            if [[ "$ENVIRONMENT_OS" != 'rhel' ]] ; then
              echo "RedHat Certification is available only for RHEL environment"
              exit -1
            fi
            desc+=" rhcert"
          fi
          desc+=" (num=$NUM osc=$CONTROLLER_COUNT cc=$CONTRAIL_CONTROLLER_COUNT ca=$CONTRAIL_ANALYTICS_COUNT cadb=$CONTRAIL_ANALYTICSDB_COUNT, $CLEAN_ENV)"
          echo "DESCRIPTION $desc"
      - description-setter:
          regexp: "DESCRIPTION (.*)"
      - shell: |
          #!/bin/bash -ex
          if [[ "$AAA_MODE_ANALYTICS" == 'auto' ]] ; then
            export AAA_MODE_ANALYTICS=$AAA_MODE
          fi
          ./juniper-ci/tripleo/run-contrail.sh
    publishers:
      - archive:
          artifacts: 'logs/**'
          allow-empty: 'true'
