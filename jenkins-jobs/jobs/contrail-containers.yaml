- job-template:
    name: contrail-{project}
    description: "Deploys Kubernetes plus Contrail in AIO mode: {project}"
    defaults: global
    properties:
      - build-discarder:
          num-to-keep: 10
    concurrent: true
    parameters:
      - choice:
          name: CLEAN_BEFORE
          choices:
            - 'false'
            - 'true'
            - clean_and_exit
      - choice:
          name: CLEAN_ENV
          choices:
            - always
            - on_success
            - never
      - choice:
          name: OPENSTACK_VERSION
          choices:
            - ocata
            - newton
      - choice:
          name: LINUX_DISTR
          description: OS to build containers for
          choices:
            - same_as_host_os
            - centos
            - ubuntu
      - string:
          name: CCB_PATCHSET
          description: "Additional command to fetch patchset for contrail-container-builer repo. Ex: git fetch https://review.opencontrail.org/Juniper/contrail-container-builder refs/changes/43/38943/1 && git cherry-pick FETCH_HEAD"
      - string:
          name: CAD_PATCHSET
          description: "Additional command to fetch patchset for contrail-ansible-deployer. Ex: same as previous."
        - string:
          name: CCB_REPO
          description: "Custom remote URL for contrail-container-builer. If empty Juniper one is used."
        - node:
          name: SLAVE_NAME
          description: "Select slave: one for specific node or multiple for any node."
          default-slaves: '{obj:slavenode}'
          allowed-slaves: '{obj:slavenode}'
          ignore-offline-nodes: false
          allowed-multiselect: true
    scm:
      - juniper-ci
      - contrail-build-poc
      - contrail-container-builder
      - contrail-ansible-deployer
    builders:
      - shell: |
          #!/bin/bash -e
          if [[ -n "$CCB_REPO" ]]; then
            pushd contrail-container-builder
            git remote add custom $CCB_REPO
            git fetch custom
            git checkout custom/master
            popd
          fi
          if [[ -n "$CCB_PATCHSET" ]]; then
            pushd contrail-container-builder
            eval "$CCB_PATCHSET"
            popd
          fi
          if [[ -n "$CAD_PATCHSET" ]]; then
            pushd contrail-ansible-deployer
            eval "$CAD_PATCHSET"
            popd
          fi
          export CONTRAIL_VERSION='{contrail_version}'
          export CONTRAIL_INSTALL_PACKAGES_URL='{packages_url}'
          # use newton for now. openstack-helm uses containers from newton...
          export WAY=$(echo {project} | cut -d '-' -f 1)
          export HOST=$(echo {project} | cut -d '-' -f 2)
          export ENVIRONMENT_OS=$(echo {project} | cut -d '-' -f 3)
          export BUILD_TARGET=$(echo {project} | cut -d '-' -f 4)
          if [[ -z "$BUILD_TARGET" ]] ; then
            export BUILD_TARGET="containers"
          fi
          if [[ "$LINUX_DISTR" == 'same_as_host_os' ]] ; then
            export LINUX_DISTR="$ENVIRONMENT_OS"
          fi
          if [[ "$LINUX_DISTR" == 'ubuntu' ]] ; then
            # hardcode it for now
            export ENVIRONMENT_OS_VERSION='xenial'
          fi
          env|sort
          ./juniper-ci/contrail-containers/$WAY/run.sh
    publishers:
      - archive:
          artifacts: 'logs/**'
          allow-empty: true

# TODO: set slave_kvm instead of slave01 when cleaning up technology will be clear for us
- project:
    name: contrail-containers
    project:
      - helm-aws-ubuntu:
          slavenode:
            - master
          contrail_version: 4.1.0.0-8
          packages_url: ''
      - helm-aws-centos:
          slavenode:
            - master
          contrail_version: 4.1.0.0-8
          packages_url: ''
#      - helm-aws-centos-all:
#          slavenode:
#            - master
#          contrail_version: 4.2.0.0-1
      - k8s-server-centos:
          slavenode:
            - slave01
            - slave02
            - slave03
          contrail_version: 4.1.0.0-8
          packages_url: ''
      - k8s-server-ubuntu:
          slavenode:
            - slave01
            - slave02
            - slave03
          contrail_version: 4.1.0.0-8
          packages_url: ''
      - k8s-server-centos-containers-mainline:
          slavenode:
            - slave01
            - slave02
            - slave03
          contrail_version: 5.0.0-126
          packages_url: 'https://s3-us-west-2.amazonaws.com/contrailpkgs/contrail-install-packages_5.0.0-126-ocata.tgz'
      - k8s-server-ubuntu-containers-mainline:
          slavenode:
            - slave01
            - slave02
            - slave03
          contrail_version: 5.0.0-93
          packages_url: 'https://s3-us-west-2.amazonaws.com/contrailpkgs/contrail-install-packages_5.0.0-93-ocata.tgz'
      - compose-server-centos:
          slavenode:
            - slave01
            - slave02
            - slave03
          contrail_version: 4.1.0.0-8
          packages_url: ''
      - compose-server-ubuntu:
          slavenode:
            - slave01
            - slave02
            - slave03
          contrail_version: 4.1.0.0-8
          packages_url: ''
      - kolla-aws-centos:
          slavenode:
            - master
          contrail_version: 4.1.0.0-8
          packages_url: ''
    jobs:
      - 'contrail-{project}'
