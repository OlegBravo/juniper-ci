- job-template:
    name: contrail-{project}
    description: "Deploys Kubernetes plus Contrail in AIO mode: {project}"
    defaults: global
    node: '{slavenode}'
    properties:
      - build-discarder
    parameters:
      - choice:
          name: CLEAN_BEFORE
          choices:
            - 'false'
            - 'true'
            - clean_and_exit
      - choice:
          name: CLEAN_ENV
          choices:
            - always
            - on_success
            - never
      - string:
          name: OPENSTACK_HELM_URL
          default: https://github.com/cloudscaling/openstack-helm
          description: "repository with OpenStack Helm project"
    scm:
      - juniper-ci
      - contrail-build-poc
      - contrail-container-builder
    builders:
      - shell: |
          #!/bin/bash -e
          export CONTRAIL_VERSION='{contrail_version}'
          export OPENSTACK_VERSION=ocata
          export WAY=$(echo {project} | cut -d '-' -f 1)
          export HOST=$(echo {project} | cut -d '-' -f 2)
          export ENVIRONMENT_OS=$(echo {project} | cut -d '-' -f 3)
          export BUILD_TARGET=$(echo {project} | cut -d '-' -f 4)
          if [[ -z "$BUILD_TARGET" ]] ; then
            export BUILD_TARGET="containers"
          fi
          env|sort
          ./juniper-ci/contrail-containers/$WAY/run.sh
    publishers:
      - archive:
          artifacts: 'logs/**'
          allow-empty: true

- project:
    name: contrail-containers
    project:
      - helm-aws-ubuntu:
          slavenode: master
          contrail_version: 4.1.0.0-6
      - helm-aws-centos:
          slavenode: master
          contrail_version: 4.1.0.0-6
      - helm-aws-centos-all:
          slavenode: master
          contrail_version: 4.2.0.0-1
      - k8s-server-centos:
          slavenode: slave1
          contrail_version: 4.1.0.0-6
    jobs:
      - 'contrail-{project}'
