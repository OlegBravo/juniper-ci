- job-template:
    name: contrail-{project}
    description: "Deploys Kubernetes plus Contrail in AIO mode: {project}"
    defaults: global
    node: '{slavenode}'
    properties:
      - build-discarder
    parameters:
      - choice:
          name: CLEAN_BEFORE
          choices:
            - 'false'
            - 'true'
            - clean_and_exit
      - choice:
          name: CLEAN_ENV
          choices:
            - always
            - on_success
            - never
      - bool:
          name: BUILD_PACKAGES
          description: "Build packages by CI instead of getting from hardcoded S3 URL"
          default: false
      - string:
          name: OPENSTACK_HELM_URL
          default: https://github.com/cloudscaling/openstack-helm
          description: "repository with OpenStack Helm project"
    scm:
      - juniper-ci
      - contrail-build-poc
      - contrail-container-builder
    builders:
      - shell: |
          #!/bin/bash -e
          export CONTRAIL_VERSION=4.0.2.0-35
          export OPENSTACK_VERSION=ocata
          export WAY=$(echo {project} | cut -d '-' -f 1)
          export HOST=$(echo {project} | cut -d '-' -f 2)
          export ENVIRONMENT_OS=$(echo {project} | cut -d '-' -f 3)
          env|sort
          ./juniper-ci/contrail-containers/run.sh
    publishers:
      - archive:
          artifacts: 'logs/**'
          allow-empty: true

- project:
    name: contrail-containers
    project:
      - helm-aws-ubuntu:
          slavenode: master
      - helm-aws-centos:
          slavenode: master
      - helm-server-ubuntu:
          slavenode: slave1
      - helm-server-centos:
         slavenode: slave1
      - k8s-server-centos:
         slavenode: slave1
    jobs:
      - 'contrail-{project}'
