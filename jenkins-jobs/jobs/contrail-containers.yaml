- job-template:
    name: contrail-{project}
    description: "Deploys Kubernetes plus Contrail in AIO mode: {project}"
    defaults: global
    properties:
      - build-discarder:
          num-to-keep: 10
    concurrent: true
    parameters:
      - choice:
          name: CLEAN_BEFORE
          choices:
            - 'false'
            - 'true'
            - clean_and_exit
      - choice:
          name: CLEAN_ENV
          choices:
            - always
            - on_success
            - never
      - choice:
          name: REGISTRY
          choices:
            - build
            - opencontrailnightly
      - choice:
          name: OPENSTACK_VERSION
          choices:
            - ocata
            - newton
      - choice:
          name: AGENT_MODE
          choices:
            - kmod
            - dpdk
      - choice:
          name: TLS
          choices:
            - disabled
            - contrail
      - string:
          name: CCB_PATCHSET
          description: "Additional command to fetch patchset for contrail-container-builer repo."
      - string:
          name: CAD_PATCHSET
          description: "Additional command to fetch patchset for contrail-ansible-deployer. Ex: same as previous."
      - text:
          name: PATCHSET_LIST
          description: "List of additional commands to fetch changes. Job will grep only required repo-s from list."
      - node:
          name: SLAVE_NAME
          description: "Select slave: one for specific node or multiple for any node."
          default-slaves: '{obj:slavenode}'
          allowed-slaves: '{obj:slavenode}'
          ignore-offline-nodes: false
          allowed-multiselect: true
    scm:
      - juniper-ci
      - contrail-container-builder
      - contrail-ansible-deployer
    builders:
      - shell: |
          #!/bin/bash -e
          if [[ -n "$CCB_REPO" ]]; then
            pushd contrail-container-builder
            git remote add custom $CCB_REPO
            git fetch custom
            git checkout custom/master
            popd
          fi
          if [[ -n "$CCB_PATCHSET" ]]; then
            pushd contrail-container-builder
            eval "$CCB_PATCHSET"
            popd
          fi
          if [[ -n "$CAD_PATCHSET" ]]; then
            pushd contrail-ansible-deployer
            eval "$CAD_PATCHSET"
            popd
          fi
          # only centos images are supported now and thus only one archive with rpm-s is needed
          export LINUX_DISTR=centos
          export CONTRAIL_VERSION='5.1.0-91'
          export CONTRAIL_INSTALL_PACKAGES_URL="https://s3-us-west-2.amazonaws.com/contrailpkgs/contrail-install-packages_"$CONTRAIL_VERSION"-ocata.tgz"

          export WAY=$(echo {project} | cut -d '-' -f 1)
          export HOST=$(echo {project} | cut -d '-' -f 2)
          export ENVIRONMENT_OS=$(echo {project} | cut -d '-' -f 3)
          if [[ "$ENVIRONMENT_OS" == 'ubuntu' ]]; then
            export ENVIRONMENT_OS_VERSION='xenial'
          fi
          # process TLS here to avoid duplication between targets
          case "$TLS" in
            "contrail" )
              export SSL_ENABLE=true
              ;;
            * )
              export SSL_ENABLE=false
              ;;
          esac
          env|sort
          ./juniper-ci/contrail-containers/$WAY/run.sh
    publishers:
      - archive:
          artifacts: 'logs/**'
          allow-empty: true

# TODO: set slave_kvm instead of slave01 when cleaning up technology will be clear for us
- project:
    name: contrail-containers
    project:
      - helm-aws-ubuntu:
          slavenode:
            - master
      - helm-server-ubuntu:
          slavenode:
            - slave01
            - slave04
      - k8s-server-centos:
          slavenode:
            - slave01
            - slave04
      - k8s-server-ubuntu:
          slavenode:
            - slave01
            - slave04
      - ansible-server-centos:
          slavenode:
            - slave01
            - slave04
      - ansible-server-ubuntu:
          slavenode:
            - slave01
            - slave04
      - ak8s-server-centos:
          slavenode:
            - slave01
            - slave04
      - kolla-aws-centos:
          slavenode:
            - master
      - kolla-aws-ubuntu:
          slavenode:
            - master

# for old packages use this additions:
#          contrail_version: 4.1.0.0-8
#          packages_url: ''

    jobs:
      - 'contrail-{project}'
