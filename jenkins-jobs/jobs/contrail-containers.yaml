- job-template:
    name: contrail-{project}
    description: "Deploys Kubernetes plus Contrail in AIO mode: {project}"
    defaults: global
    concurrent: true
    properties:
      - build-discarder
    parameters:
      - choice:
          name: CLEAN_BEFORE
          choices:
            - 'false'
            - 'true'
            - clean_and_exit
      - choice:
          name: CLEAN_ENV
          choices:
            - always
            - on_success
            - never
      - choice:
          name: OPENSTACK_VERSION
          choices:
            - ocata
            - newton
      - choice:
          name: LINUX_DISTR
          description: OS to build containers for
          choices:
            - same_as_host_os
            - centos
            - ubuntu
      - node:
          name: SLAVE_NAME
          description: "Select slave: one for specific node or multiple for any node."
          default-slaves: '{obj:slavenode}'
          allowed-slaves: '{obj:slavenode}'
          ignore-offline-nodes: false
          allowed-multiselect: true
    scm:
      - juniper-ci
      - contrail-build-poc
      - contrail-container-builder
      - contrail-ansible-deployer
    builders:
      - shell: |
          #!/bin/bash -e
          export CONTRAIL_VERSION='{contrail_version}'
          # use newton for now. openstack-helm uses containers from newton...
          export WAY=$(echo {project} | cut -d '-' -f 1)
          export HOST=$(echo {project} | cut -d '-' -f 2)
          export ENVIRONMENT_OS=$(echo {project} | cut -d '-' -f 3)
          export BUILD_TARGET=$(echo {project} | cut -d '-' -f 4)
          if [[ -z "$BUILD_TARGET" ]] ; then
            export BUILD_TARGET="containers"
          fi
          if [[ "$LINUX_DISTR" == 'same_as_host_os' ]] ; then
            export LINUX_DISTR="$ENVIRONMENT_OS"
          fi
          env|sort
          ./juniper-ci/contrail-containers/$WAY/run.sh
    publishers:
      - archive:
          artifacts: 'logs/**'
          allow-empty: true

# TODO: set slave_kvm instead of slave01 when cleaning up technology will be clear for us
- project:
    name: contrail-containers
    project:
      - helm-aws-ubuntu:
          slavenode:
            - master
          contrail_version: 4.1.0.0-6
      - helm-aws-centos:
          slavenode:
            - master
          contrail_version: 4.1.0.0-6
#      - helm-aws-centos-all:
#          slavenode:
#            - master
#          contrail_version: 4.2.0.0-1
      - k8s-server-centos:
          slavenode:
            - slave01
            - slave02
            - slave03
          contrail_version: 4.1.0.0-6
      - compose-server-centos:
          slavenode:
            - slave01
            - slave02
            - slave03
          contrail_version: 4.1.0.0-6
      - kolla-aws-centos:
          slavenode:
            - master
          contrail_version: 4.1.0.0-6
    jobs:
      - 'contrail-{project}'
